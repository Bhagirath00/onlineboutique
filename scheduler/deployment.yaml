##############################################
# NEXUS Scheduler Extender — Deployment
# 
# This deploys NEXUS as a Scheduler Extender
# that cooperates with the default kube-scheduler.
# kube-scheduler calls NEXUS at /filter and
# /prioritize before making placement decisions.
##############################################

---
# Namespace for NEXUS components
apiVersion: v1
kind: Namespace
metadata:
  name: nexus-system
  labels:
    app: nexus-scheduler
    component: extender

---
# RBAC: ServiceAccount for NEXUS
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nexus-scheduler
  namespace: nexus-system

---
# RBAC: ClusterRole — read-only access to pods and nodes
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: nexus-scheduler
rules:
  # Read pods (for dependency graph and gang member counting)
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  # Read nodes (for scoring)
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]
  # Create events (for observability)
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

---
# RBAC: Bind the role
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: nexus-scheduler
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: nexus-scheduler
subjects:
  - kind: ServiceAccount
    name: nexus-scheduler
    namespace: nexus-system

---
# NEXUS Scheduler Extender Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexus-scheduler
  namespace: nexus-system
  labels:
    app: nexus-scheduler
    component: extender
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexus-scheduler
  template:
    metadata:
      labels:
        app: nexus-scheduler
        component: extender
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9099"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: nexus-scheduler
      containers:
        - name: nexus-scheduler
          image: nexus-scheduler:v2.0
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 9099
              name: http
              protocol: TCP
          env:
            - name: PROMETHEUS_URL
              value: "http://prometheus-server.monitoring:80"
            - name: SPIKE_QPS_THRESHOLD
              value: "1000"
            - name: SPIKE_ERROR_THRESHOLD
              value: "50"
            - name: SPIKE_P95_LATENCY_THRESHOLD
              value: "500"
          readinessProbe:
            httpGet:
              path: /readyz
              port: 9099
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /healthz
              port: 9099
            initialDelaySeconds: 10
            periodSeconds: 30
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi

---
# Service to expose NEXUS to kube-scheduler
apiVersion: v1
kind: Service
metadata:
  name: nexus-scheduler
  namespace: nexus-system
  labels:
    app: nexus-scheduler
spec:
  selector:
    app: nexus-scheduler
  ports:
    - port: 9099
      targetPort: 9099
      protocol: TCP
      name: http
  type: ClusterIP

---
# KubeSchedulerConfiguration — tells kube-scheduler about NEXUS
# NOTE: In Minikube, this needs to be mounted into kube-scheduler.
# For the research experiment, we can use the --config flag.
apiVersion: v1
kind: ConfigMap
metadata:
  name: nexus-scheduler-policy
  namespace: nexus-system
data:
  scheduler-policy.json: |
    {
      "kind": "Policy",
      "apiVersion": "v1",
      "extenders": [
        {
          "urlPrefix": "http://nexus-scheduler.nexus-system.svc.cluster.local:9099",
          "filterVerb": "filter",
          "prioritizeVerb": "prioritize",
          "weight": 5,
          "enableHttps": false,
          "managedResources": [],
          "ignorable": true
        }
      ]
    }
